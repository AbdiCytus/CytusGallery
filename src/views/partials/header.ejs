<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CytusGallery</title>
  <link href="/css/style.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />
</head>

<body class="bg-gray-900 text-white min-h-screen overflow-x-hidden">
  <script>
    (function() {
      // Jalankan hanya di halaman utama
      if (window.location.pathname !== '/') return;

      // Fungsi untuk membangun URL dari filter
      const buildUrlFromFilters = (filters) => {
        const params = new URLSearchParams();
        let filterQueryParts = [];

        if (filters.ratingToggle && filters.rating && filters.rating !== "all") {
          let ratingTag = filters.rating === "not_g" ? "-rating:g" : (filters.rating === "not_e" ? "-rating:e" : `rating:${filters.rating}`);
          filterQueryParts.push(ratingTag);
        }
        if (filters.typeToggle && filters.type) {
          let typeTag = '';
          if (filters.type === 'image') typeTag = 'filetype:jpg,jpeg,png,webp,gif,avif';
          else if (filters.type === 'video') typeTag = 'filetype:mp4,webm';
          if (typeTag) filterQueryParts.push(typeTag);
        }

        const filterQuery = filterQueryParts.join(' ');
        if (filterQuery) {
          params.append('query', filterQuery);
        }

        params.append('limit', filters.limit || 25);
        if (filters.lazyloadToggle) {
          params.append('lazyload', 'true');
        }

        const queryString = params.toString();
        return `/search?${queryString}`;
      };

      let filters = JSON.parse(localStorage.getItem("cytusGalleryFilters"));

      // Jika pengguna baru (tidak ada setting), buat defaultnya
      if (!filters) {
        filters = {
          ratingToggle: true,
          rating: "g",
          typeToggle: false,
          type: "image",
          limit: "25",
          autoplayToggle: false,
          lazyloadToggle: true,
        };
        localStorage.setItem("cytusGalleryFilters", JSON.stringify(filters));
      }

      // Cek jika perlu redirect (pengguna baru atau ada filter aktif)
      const needsRedirect = !localStorage.getItem("cytusGalleryFilters") || filters.ratingToggle || filters.typeToggle;

      if (needsRedirect) {
        const newUrl = buildUrlFromFilters(filters);
        // Ganti halaman saat ini, ini lebih cepat dari redirect biasa
        window.location.replace(newUrl);
      }
    })();
  </script>


  <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-30 opacity-0 pointer-events-none transition-opacity duration-300"></div>

  <aside id="sidebar" class="fixed top-0 right-0 h-full w-72 bg-gray-800 shadow-lg z-40 transform translate-x-full transition-transform duration-300">
    <div class="p-4 h-full flex flex-col">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-white">Pengaturan</h2>
        <button id="close-sidebar-button" class="text-gray-400 hover:text-white">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <form action="/search" method="GET" id="filter-form" class="flex-grow flex flex-col overflow-hidden">

        <div class="flex-grow space-y-6 overflow-y-auto pr-4 text-gray-300 py-3">

          <div>
            <div class="flex justify-between items-center">
              <h3 class="font-semibold text-white">Filter Rating</h3>
              <label for="rating-toggle" class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="rating-toggle" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
              </label>
            </div>
            <div id="rating-options" class="hidden mt-3 space-y-2">
              <input type="radio" name="rating" value="g" id="rating-g" class="hidden peer/safe">
              <label for="rating-g" class="w-full block text-start px-3 py-2 border-2 border-transparent rounded-md text-sm cursor-pointer hover:bg-gray-700 peer-checked/safe:border-green-500 peer-checked/safe:bg-green-900/50">Safe</label>

              <input type="radio" name="rating" value="not_e" id="rating-not_e" class="hidden peer/moderate">
              <label for="rating-not_e" class="w-full block text-start px-3 py-2 border-2 border-transparent rounded-md text-sm cursor-pointer hover:bg-gray-700 peer-checked/moderate:border-yellow-500 peer-checked/moderate:bg-yellow-900/50">Moderate</label>

              <input type="radio" name="rating" value="not_g" id="rating-not_g" class="hidden peer/explicit">
              <label for="rating-not_g" class="w-full block text-start px-3 py-2 border-2 border-transparent rounded-md text-sm cursor-pointer hover:bg-gray-700 peer-checked/explicit:border-red-500 peer-checked/explicit:bg-red-900/50">Explicit</label>
            </div>
          </div>

          <div class="pt-6 border-t border-gray-700">
            <div class="flex justify-between items-center">
              <h3 class="font-semibold text-white">Filter Tipe</h3>
              <label for="type-toggle" class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="type-toggle" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
              </label>
            </div>
            <div id="type-options" class="hidden mt-3 space-y-2 text-sm">
              <input type="radio" name="type" value="image" id="type-image" class="hidden peer/image">
              <label for="type-image" class="w-full block text-start px-3 py-2 border-2 border-transparent rounded-md text-sm cursor-pointer hover:bg-gray-700 peer-checked/image:border-cyan-500 peer-checked/image:bg-cyan-900/50">Gambar</label>

              <input type="radio" name="type" value="video" id="type-video" class="hidden peer/video">
              <label for="type-video" class="w-full block text-start px-3 py-2 border-2 border-transparent rounded-md text-sm cursor-pointer hover:bg-gray-700 peer-checked/video:border-cyan-500 peer-checked/video:bg-cyan-900/50">Video</label>
            </div>
          </div>

          <div class="pt-6 border-t border-gray-700">
            <label for="limit-input" class="font-semibold mb-2 block text-white">Konten per Halaman</label>
            <input type="number" name="limit" id="limit-input" value="25" min="10" max="200" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white">
          </div>

          <div class="pt-6 border-t border-gray-700">
            <h3 class="font-semibold text-white mb-3">Pengaturan Lain</h3>
            <div class="flex justify-between items-center text-sm mb-2">
              <label for="autoplay-toggle">Autoplay Video saat Hover</label>
              <label for="autoplay-toggle" class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="autoplay-toggle" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
              </label>
            </div>
            <div class="flex justify-between items-center text-sm">
              <label for="lazyload-toggle">Lazy Loading Gambar</label>
              <label for="lazyload-toggle" class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="lazyload-toggle" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
              </label>
            </div>
          </div>
        </div>

        <div class="mt-auto pt-4 border-t border-gray-700">
          <button type="submit" class="w-full text-center bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md">
            Terapkan Filter
          </button>
        </div>
      </form>

    </div>
  </aside>

  <header class="bg-gray-800/50 backdrop-blur-sm sticky top-0 z-40">
    <nav class="container mx-auto p-4 flex justify-between items-center">
      <a href="/" class="text-2xl font-bold text-cyan-400">CytusGallery</a>
      <button id="open-sidebar-button" class="space-y-2 cursor-pointer">
        <span class="block w-8 h-0.5 bg-gray-100"></span>
        <span class="block w-8 h-0.5 bg-gray-100"></span>
        <span class="block w-8 h-0.5 bg-gray-100"></span>
      </button>
    </nav>
  </header>

  <section class="container mx-auto px-4 py-2">
    <div class="relative">
      <form action="/search" method="GET" id="search-form">
        <div class="relative">
          <input type="text" name="tags" id="search-input" class="w-full bg-gray-700 border border-gray-600 rounded-md py-3 pl-4 pr-12 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Cari berdasarkan tag..." autocomplete="off" value="<%= typeof userTags !== 'undefined' ? userTags.replace(/_/g, ' ') : tags.replace(/_/g, ' ') %>">
          <button type="submit" class="absolute inset-y-0 right-0 flex items-center pr-4 text-gray-400 hover:text-cyan-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
            </svg>
          </button>
        </div>
      </form>
      <div id="suggestions-box" class="absolute z-40 w-full bg-gray-800 border border-gray-700 rounded-md mt-1 hidden">
      </div>
    </div>
  </section>
  <script></script>