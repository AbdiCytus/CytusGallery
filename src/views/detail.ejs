<%- include('partials/header', { tags: '' }) %>

<main class="container mx-auto p-4">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-8">

    <div class="md:col-span-2 bg-gray-800 rounded-lg p-2 flex justify-center items-center">
      <% if (post.file_ext === 'mp4' || post.file_ext === 'webm' || post.file_ext === "zip") { %>
      <video src="<%= post.large_file_url %>" class="max-w-full max-h-[90vh] rounded-md" controls autoplay loop muted></video>
      <% } else { %>
      <img src="<%= post.large_file_url %>" alt="Detail konten" class="max-w-full max-h-[90vh] rounded-md">
      <% } %>
    </div>

    <div class="md:col-span-1">
      <h2 class="text-2xl font-bold mb-4">Informasi & Tag</h2>
      <div class="space-y-4">

        <div>
          <h3 class="font-semibold mb-2 text-gray-400">Metadata</h3>
          <div class="flex flex-wrap gap-2 text-sm">
            <span class="bg-gray-700 px-2 py-1 rounded-md"><strong>ID:</strong> <%= post.id %></span>
            <span class="bg-gray-700 px-2 py-1 rounded-md"><strong>Rating:</strong> <%= post.rating.toUpperCase() %></span>
            <span class="bg-gray-700 px-2 py-1 rounded-md"><strong>Score:</strong> <%= post.score %></span>
            <span class="bg-gray-700 px-2 py-1 rounded-md"><strong>Size:</strong> <%= (post.file_size / 1024 / 1024).toFixed(2) %> MB</span>
            <span class="bg-gray-700 px-2 py-1 rounded-md"><strong>Dimensions:</strong> <%= post.image_width %>x<%= post.image_height %></span>
            <span class="bg-gray-700 px-2 py-1 rounded-md"><strong>Uploaded:</strong> <%= new Date(post.created_at).toLocaleDateString('id-ID', { day: 'numeric', 'month': 'short', 'year': 'numeric' }) %></span>
            <% if (post.source) { %>
            <a href="<%= post.source %>" target="_blank" rel="noopener noreferrer" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded-md flex items-center gap-1">
              <strong>Source</strong>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
              </svg>
            </a>
            <% } %>
          </div>
        </div>

        <%const renderTags = (title, tagString, colorClass) => {
            if (tagString && tagString.trim() !== '') {
                  const tags = tagString.split(' ');%>
        <div>
          <h3 class="font-semibold mb-2 <%= colorClass %>"><%= title %></h3>
          <div class="flex flex-wrap gap-2">
            <% tags.forEach(tag => { %>
            <a href="/search?tags=<%= tag %>" class="bg-gray-700 hover:bg-gray-600 tag-link text-sm px-2 py-1 rounded-md">
              <%= tag.replace(/_/g, ' ') %>
            </a>
            <% }); %>
          </div>
        </div>
        <%
            }
          }
        %>
        <% renderTags('Copyright', post.tag_string_copyright, 'text-purple-400'); %>
        <% renderTags('Character(s)', post.tag_string_character, 'text-green-400'); %>
        <% renderTags('Artist', post.tag_string_artist, 'text-red-400'); %>
        <% renderTags('Meta Tags', post.tag_string_meta, 'text-yellow-400'); %>
        <% renderTags('General Tags', post.tag_string_general, 'text-blue-400'); %>

        <div class="pt-4 space-y-3">
          <button id="download-button" class="w-full block text-center bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md">
            Download Original
          </button>
          <a href="<%= post.large_file_url %>" target="_blank" rel="noopener noreferrer" class="w-full block text-center bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">
            Lihat Gambar Penuh
          </a>
          <button id="share-button" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">
            Salin Link
          </button>
        </div>
      </div>
    </div>
  </div>
</main>

<div id="success-modal" class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
  <div id="success-modal-backdrop" class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>

  <div class="relative rounded-lg p-4 bg-gray-800 border border-gray-700 shadow-2xl w-11/12 max-w-sm transform scale-95 transition-transform duration-300 text-center">

    <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-900/30 mb-2 ring-1 ring-green-500/50">
      <svg class="h-10 w-10 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
      </svg>
    </div>

    <h3 class="text-2xl font-bold text-white tracking-wide">Berhasil!</h3>

    <div class="mt-3">
      <p class="text-sm text-gray-400 leading-relaxed">
        Link tautan telah berhasil disalin ke clipboard.
      </p>
    </div>

    <div class="mt-3 flex justify-center">
      <button id="close-modal-btn" type="button" class=" rounded inline-flex w-full py-1 justify-center shadow-lg shadow-cyan-900/20 bg-cyan-600 text-sm font-bold text-white hover:bg-cyan-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-cyan-500 transition-colors duration-200">
        OK
      </button>
    </div>
  </div>
</div>

<script>
  // Logika untuk tombol Download
  const downloadButton = document.getElementById('download-button');
  if (downloadButton) {
    downloadButton.addEventListener('click', async () => {
      const fileUrl = '<%= post.file_url %>';
      const filename = '<%= post.md5 %>.<%= post.file_ext %>';

      // Beri feedback ke user
      downloadButton.textContent = 'Downloading...';
      downloadButton.disabled = true;

      try {
        // Ambil data file sebagai blob
        const response = await fetch(fileUrl);
        const blob = await response.blob();

        // Buat URL sementara untuk blob
        const blobUrl = window.URL.createObjectURL(blob);

        // Buat link sementara, klik, lalu hapus
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = blobUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();

        // Hapus link dan URL sementara
        window.URL.revokeObjectURL(blobUrl);
        a.remove();
      } catch (err) {
        console.error('Download error:', err);
        alert('Gagal mengunduh file.');
      } finally {
        // Kembalikan tombol ke keadaan semula
        downloadButton.textContent = 'Download Original';
        downloadButton.disabled = false;
      }
    });
  }
  // === LOGIKA SHARE & MODAL ===
  document.addEventListener('DOMContentLoaded', () => {
    const shareButton = document.getElementById('share-button');
    const modal = document.getElementById('success-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const backdrop = document.getElementById('success-modal-backdrop');

    // Fungsi: Tampilkan Modal
    const showSuccessModal = () => {
      modal.classList.remove('opacity-0', 'pointer-events-none');
      modal.querySelector('.transform').classList.remove('scale-95');
      modal.querySelector('.transform').classList.add('scale-100');
    };

    // Fungsi: Sembunyikan Modal
    const hideSuccessModal = () => {
      modal.classList.add('opacity-0', 'pointer-events-none');
      modal.querySelector('.transform').classList.add('scale-95');
      modal.querySelector('.transform').classList.remove('scale-100');
    };

    // Event Listener Tutup Modal
    if (closeModalBtn) closeModalBtn.addEventListener('click', hideSuccessModal);
    if (backdrop) backdrop.addEventListener('click', hideSuccessModal);

    // Event Listener Tombol Share
    if (shareButton) {
      shareButton.addEventListener('click', async () => {
        const url = window.location.href;

        // Fungsi Helper: Copy Manual (Fallback untuk HTTP/Mobile Lama)
        const manualCopy = () => {
          const textArea = document.createElement("textarea");
          textArea.value = url;
          textArea.style.position = "fixed";
          textArea.style.left = "-9999px";
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          try {
            document.execCommand('copy');
            showSuccessModal(); // Tampilkan modal sukses
          } catch (err) {
            prompt('Salin link manual:', url);
          }
          document.body.removeChild(textArea);
        };

        try {
          // Coba cara modern dulu (Clipboard API)
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(url);
            showSuccessModal(); // Tampilkan modal sukses
          } else {
            throw new Error("Clipboard API unavailable");
          }
        } catch (err) {
          // Jika gagal (misal karena belum HTTPS), pakai cara manual
          manualCopy();
        }
      });
    }
  });
</script>

<%- include('partials/footer') %>