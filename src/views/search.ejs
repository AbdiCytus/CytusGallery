<%
  const formatTags = (tagString, fallback = 'Original') => {
    if (!tagString || tagString.trim() === '') return fallback;
    const toTitleCase = (str) => str.replace(/\b\w/g, char => char.toUpperCase());

    const tags = tagString.split(' ');
    const formattedTags = tags.map(tag => {
      const spacedTag = tag.replace(/_/g, ' '); 
      return toTitleCase(spacedTag);
    });

    return formattedTags.join(', ');
  };
%>

<%- include('partials/header') %>

<main class="container mx-auto p-4">
  <% if (sliderPosts.length > 0) { %>
  <h2 class="text-2xl font-bold mb-4 text-white text-start px-4">Popular Contents</h2>
  <div class="swiper mb-12">
    <div class="swiper-wrapper">
      <% sliderPosts.forEach(post => { %>
      <% if(post.large_file_url) { %>
      <div class="swiper-slide group gallery-item relative bg-gray-800 rounded-lg overflow-hidden group-hover:z-10" data-post-url="/posts/<%= post.id %>" <% if (post.large_file_url.endsWith('.mp4') || post.large_file_url.endsWith('.webm')) { %> data-is-video="true" data-video-url="<%= post.large_file_url %>" data-preview-url="<%= post.media_asset?.variants.find(v => v.type === '720x720')?.url || post.media_asset?.variants.find(v => v.type === '360x360')?.url || post.preview_file_url %>" <% } else { %> data-is-video="false" <% } %>>
        <div class="absolute top-1.5 right-1.5 z-20 flex items-center gap-1.5">
          <span class="bg-blue-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-md shadow-md"><%= post.file_ext.toUpperCase() %></span>

          <% if (post.rating) { %>
          <% 
            let ratingColor = '';
            switch (post.rating) {
                case 'g': // General
                    ratingColor = 'bg-green-600'; // Safe (Hijau)
                    break;
                case 's': // Sensitive
                    ratingColor = 'bg-yellow-600'; // Moderate (Kuning)
                    break;
                case 'q': // Questionable
                    ratingColor = 'bg-purple-600'; // Questionable (Ungu)
                    break;
                case 'e': // Explicit
                    ratingColor = 'bg-red-600'; // Explicit (Merah)
                    break;
            }
        %>
          <span class="<%= ratingColor %> text-white text-[10px] font-bold px-1.5 py-0.5 rounded-md shadow-md"><%= post.rating.toUpperCase() %></span>
          <% } %>
        </div>

        <div class="media-container relative w-full h-auto aspect-video bg-black">
          <% if (post.large_file_url.endsWith('.mp4') || post.large_file_url.endsWith('.webm')) { %>
          <img src="<%= post.media_asset?.variants.find(v => v.type === '720x720')?.url || post.media_asset?.variants.find(v => v.type === '360x360')?.url || post.preview_file_url %>" alt="Video preview" class="absolute inset-0 w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
          <video class="video-playback hidden absolute inset-0 w-full h-full object-cover" preload="none" loop muted playsinline></video>
          <% } else { %>
          <img src="<%= post.large_file_url %>" alt="Konten oleh: <%= post.tag_string_artist %>" class="absolute inset-0 w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" <%= isLazyLoadEnabled ? 'loading="lazy"' : '' %>>
          <% } %>
        </div>

        <div class="overlay absolute inset-0 bg-gradient-to-t from-black/90 via-black/60 to-transparent p-3 flex flex-col justify-end text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300">
          <div class="overlay-content">
            <h4 class="font-bold truncate"><%= formatTags(post.tag_string_character, 'Unknown Character') %></h4>
            <p class="text-sm truncate"><%= formatTags(post.tag_string_copyright, 'Original') %></p>
            <a href="/posts/<%= post.id %>" class="detail-button mt-2 text-center w-full block bg-cyan-600 text-xs py-1 rounded-md hover:bg-cyan-700">Lihat Detail</a>
          </div>
        </div>
      </div>
      <% } %>
      <% }); %>
    </div>
    <div class="swiper-button-next text-white"></div>
    <div class="swiper-button-prev text-white"></div>
  </div>
  <% } %>
  <h2 class="text-2xl font-bold mb-4 text-white text-start px-4">Contents</h2>
  <div id="main-gallery" class="columns-2 md:columns-5 gap-4 space-y-4">

    <%# Cek apakah ada postingan untuk ditampilkan %>
    <% if (posts && posts.length > 0) { %>
    <% posts.forEach((post, index) => { %>
    <% if (post.large_file_url) { %>
    <div class="group gallery-item relative break-inside-avoid bg-gray-800 rounded-md overflow-hidden" data-post-url="/posts/<%= post.id %>" <% if (post.large_file_url.endsWith('.mp4') || post.large_file_url.endsWith('.webm')) { %> data-is-video="true" data-video-url="<%= post.large_file_url %>" data-preview-url="<%= post.media_asset?.variants.find(v => v.type === '720x720')?.url || post.media_asset?.variants.find(v => v.type === '360x360')?.url || post.preview_file_url %>" <% } else { %> data-is-video="false" <% } %>>
      <div class="absolute top-1.5 left-1.5 z-20 bg-black/50 text-white text-xs px-1.5 py-0.5 rounded-full">
        <%= ((currentPage - 1) * limit) + index + 1 %>
      </div>

      <div class="absolute top-1.5 right-1.5 z-20 flex items-center gap-1.5">
        <span class="bg-blue-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-md shadow-md"><%= post.file_ext.toUpperCase() %></span>
        <% let rc; if(post.rating==='g')rc='bg-green-600'; if(post.rating==='s')rc='bg-yellow-600'; if(post.rating==='q')rc='bg-purple-600'; if(post.rating==='e')rc='bg-red-600'; %>
        <span class="<%= rc %> text-white text-[10px] font-bold px-1.5 py-0.5 rounded-md shadow-md"><%= post.rating.toUpperCase() %></span>
      </div>

      <div class="media-container w-full h-auto">
        <% if (post.large_file_url.endsWith('.mp4') || post.large_file_url.endsWith('.webm')) { %>
        <img src="<%= post.media_asset?.variants.find(v => v.type === '720x720')?.url || post.media_asset?.variants.find(v => v.type === '360x360')?.url || post.preview_file_url %>" alt="Video preview" class="video-preview w-full h-auto transition-transform duration-300 group-hover:scale-105">
        <video class="video-playback hidden w-full h-auto" preload="none" loop muted playsinline></video>
        <% } else { %>
        <img src="<%= post.media_asset?.variants.find(v => v.type === '720x720')?.url || post.media_asset?.variants.find(v => v.type === '360x360')?.url || post.large_file_url %>" alt="Konten oleh: <%= post.tag_string_artist %>" class="w-full h-auto transition-transform duration-300 group-hover:scale-105" <%= isLazyLoadEnabled ? 'loading="lazy"' : '' %>>
        <% } %>
      </div>

      <div class="overlay absolute inset-0 bg-gradient-to-t from-black/90 via-black/60 to-transparent p-3 flex flex-col justify-end text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
        <div class="overlay-content">
          <h4 class="font-bold truncate text-sm md:text-base"><%= formatTags(post.tag_string_character, 'Unknown Character') %></h4>
          <p class="text-xs md:text-sm truncate text-gray-300"><%= formatTags(post.tag_string_copyright, 'Original') %></p>

          <a href="/posts/<%= post.id %>" class="detail-button mt-2 text-center font-bold block bg-cyan-600 text-xs py-1 rounded-md hover:bg-cyan-700 pointer-events-auto">
            Lihat Detail
          </a>
        </div>
      </div>
    </div>
    <% } %>
    <% }); %>
    <% } else { %>

    <div class="absolute inset-x-0 flex flex-col items-center justify-center pt-16 text-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-gray-700 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      <h3 class="text-2xl font-semibold text-white">Tidak Ada Hasil Ditemukan</h3>
      <p class="text-gray-400 mt-2 max-w-sm">
        Tidak ada konten yang cocok untuk "<%= userTags.replace(/_/g, ' ') %>". Coba gunakan kata kunci atau kombinasi filter yang berbeda.
      </p>
    </div>

    <% } %>

  </div>
</main>

<%- include('partials/pagination', { currentPage, totalPages, limit, tagsForPagination: tagsForPagination }) %>
<% if (popularTags.length > 0 || popularCharacters.length > 0) { %>
<div class="py-8 bg-black/30">
  <div class="container mx-auto mt-12">

    <% if (popularTags.length > 0) { %>
    <section class="bg-gray-900/50 rounded-lg p-4">
      <h2 class="text-2xl font-bold mb-4 text-white text-start">Popular Series</h2>
      <div class="relative overflow-x-hidden">
        <div class="marquee-container flex">
          <div class="marquee-content flex-shrink-0 flex items-center justify-start min-w-full">
            <% popularTags.forEach(tag => { %>
            <a href="/search?tags=<%= tag.name %>" class="bg-gray-700 hover:bg-gray-600 text-base px-4 py-2 rounded-md mx-4 whitespace-nowrap tag-link"><%= tag.name.replace(/_/g, ' ') %></a>
            <% }); %>
          </div>
          <div class="marquee-content flex-shrink-0 flex items-center justify-start min-w-full">
            <% popularTags.forEach(tag => { %>
            <a href="/search?tags=<%= tag.name %>" class="bg-gray-700 hover:bg-gray-600 text-base px-4 py-2 rounded-md mx-4 whitespace-nowrap tag-link"><%= tag.name.replace(/_/g, ' ') %></a>
            <% }); %>
          </div>
        </div>
      </div>
    </section>
    <% } %>

    <% if (popularCharacters.length > 0) { %>
    <section class="mt-6 bg-gray-900/50 rounded-lg p-4">
      <h2 class="text-2xl font-bold mb-4 text-white text-start">Popular Characters</h2>
      <div class="relative overflow-x-hidden">
        <div class="marquee-container-reverse flex">
          <div class="marquee-content-reverse flex-shrink-0 flex items-center justify-start min-w-full">
            <% popularCharacters.forEach(tag => { %>
            <a href="/search?tags=<%= tag.name %>" class="bg-gray-700 hover:bg-gray-600 text-base px-4 py-2 rounded-md mx-4 whitespace-nowrap tag-link"><%= tag.name.replace(/_/g, ' ') %></a>
            <% }); %>
          </div>
          <div class="marquee-content-reverse flex-shrink-0 flex items-center justify-start min-w-full">
            <% popularCharacters.forEach(tag => { %>
            <a href="/search?tags=<%= tag.name %>" class="bg-gray-700 hover:bg-gray-600 text-base px-4 py-2 rounded-md mx-4 whitespace-nowrap tag-link"><%= tag.name.replace(/_/g, ' ') %></a>
            <% }); %>
          </div>
        </div>
      </div>
    </section>
    <% } %>
  </div>
</div>
<% } %>
<%- include('partials/footer') %>