<%- include('partials/header') %>

<main class="container mx-auto p-4">
  <h2 class="text-2xl font-semibold text-center mb-8">
    Hasil Pencarian untuk: <span class="text-cyan-400"><%= tags %></span>
  </h2>

  <% if (currentPage === 1 && sliderPosts.length > 0) { %>
  <h2 class="text-2xl font-bold mb-4 text-white">Popular Contents</h2>
  <div class="swiper mb-12">
    <div class="swiper-wrapper">
      <% sliderPosts.forEach(post => { %>
      <% if(post.large_file_url) { %>
      <div class="swiper-slide group gallery-item relative bg-gray-800 rounded-lg overflow-hidden" data-post-url="/posts/<%= post.id %>">
        <div class="absolute top-1.5 right-1.5 z-20 flex items-center gap-1.5">
          <span class="bg-blue-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-md shadow-md"><%= post.file_ext.toUpperCase() %></span>

          <% if (post.rating) { %>
          <% 
            let ratingColor = '';
            switch (post.rating) {
                case 'g': // General
                    ratingColor = 'bg-green-600'; // Safe (Hijau)
                    break;
                case 's': // Sensitive
                    ratingColor = 'bg-yellow-600'; // Moderate (Kuning)
                    break;
                case 'q': // Questionable
                    ratingColor = 'bg-purple-600'; // Questionable (Ungu)
                    break;
                case 'e': // Explicit
                    ratingColor = 'bg-red-600'; // Explicit (Merah)
                    break;
            }
        %>
          <span class="<%= ratingColor %> text-white text-[10px] font-bold px-1.5 py-0.5 rounded-md shadow-md"><%= post.rating.toUpperCase() %></span>
          <% } %>
        </div>
        <img src="<%= post.preview_file_url %>" <%# Gunakan preview agar lebih cepat loading %> alt="Slider image" class="aspect-video w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">

        <div class="overlay absolute inset-0 bg-gradient-to-t from-black/90 via-black/60 to-transparent p-3 flex flex-col justify-end text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300">
          <div class="overlay-content">
            <h4 class="font-bold truncate"><%= post.tag_string_character.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') || 'Unknown' %></h4>
            <p class="text-sm truncate"><%= post.tag_string_copyright.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') || 'Original' %></p>
            <a href="/posts/<%= post.id %>" class="detail-button mt-2 text-center w-full block bg-cyan-600 text-xs py-1 rounded-md hover:bg-cyan-700">
              Lihat Detail
            </a>
          </div>
        </div>
      </div>
      <% } %>
      <% }); %>
    </div>
    <div class="swiper-button-next text-white"></div>
    <div class="swiper-button-prev text-white"></div>
  </div>
  <% } %>
  <h2 class="text-2xl font-bold mb-4 text-white">Contents</h2>
  <div class="columns-2 md:columns-5 gap-4 space-y-4">
    <% posts.forEach((post, index) => { %>
    <% if (post.large_file_url) { %>
    <div class="group gallery-item relative break-inside-avoid bg-gray-800 rounded-md overflow-hidden" data-post-url="/posts/<%= post.id %>" <%# Perbaikan: Mengakses variants melalui post.media_asset %> <% if (post.large_file_url.endsWith('.mp4') || post.large_file_url.endsWith('.webm')) { %> data-is-video="true" data-video-url="<%= post.large_file_url %>" data-preview-url="<%= post.media_asset?.variants.find(v => v.type === '720x720')?.url || post.media_asset?.variants.find(v => v.type === '360x360')?.url || post.preview_file_url %>" <% } else { %> data-is-video="false" <% } %>>
      <div class="absolute top-1 left-1 z-20 bg-black/50 text-white text-xs px-1.5 py-0.5 rounded-full">
        <%= ((currentPage - 1) * limit) + index + 1 %>
      </div>

      <div class="absolute top-1.5 right-1.5 z-20 flex items-center gap-1.5">
        <span class="bg-blue-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-md shadow-md"><%= post.file_ext.toUpperCase() %></span>

        <% if (post.rating) { %>
        <% 
            let ratingColor = '';
            switch (post.rating) {
                case 'g': // General
                    ratingColor = 'bg-green-600'; // Safe (Hijau)
                    break;
                case 's': // Sensitive
                    ratingColor = 'bg-yellow-600'; // Moderate (Kuning)
                    break;
                case 'q': // Questionable
                    ratingColor = 'bg-purple-600'; // Questionable (Ungu)
                    break;
                case 'e': // Explicit
                    ratingColor = 'bg-red-600'; // Explicit (Merah)
                    break;
            }
        %>
        <span class="<%= ratingColor %> text-white text-[10px] font-bold px-1.5 py-0.5 rounded-md shadow-md"><%= post.rating.toUpperCase() %></span>
        <% } %>
      </div>

      <div class="media-container w-full h-auto">
        <% if (post.large_file_url.endsWith('.mp4') || post.large_file_url.endsWith('.webm')) { %>
        <img src="<%= post.media_asset?.variants.find(v => v.type === '720x720')?.url || post.media_asset?.variants.find(v => v.type === '360x360')?.url || post.preview_file_url %>" alt="Video preview" class="w-full h-auto transition-transform duration-300 group-hover:scale-105">
        <% } else { %>
        <img src="<%= post.large_file_url %>" alt="Konten oleh: <%= post.tag_string_artist %>" class="w-full h-auto transition-transform duration-300 group-hover:scale-105" <%= isLazyLoadEnabled ? 'loading="lazy"' : '' %>>
        <% } %>
      </div>

      <div class="overlay absolute inset-0 bg-gradient-to-t from-black/90 via-black/60 to-transparent p-3 flex flex-col justify-end text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300">
        <div class="overlay-content">
          <h4 class="font-bold truncate"><%= post.tag_string_character.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') || 'Unknown' %></h4>
          <p class="text-sm truncate"><%= post.tag_string_copyright.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') || 'Original' %></p>
          <a href="/posts/<%= post.id %>" class="detail-button mt-2 text-center w-full block bg-cyan-600 text-xs py-1 rounded-md hover:bg-cyan-700">
            Lihat Detail
          </a>
        </div>
      </div>
    </div>
    <% } %>
    <% }); %>
  </div>
</main>

<%- include('partials/pagination', { currentPage, totalPages, limit, tagsForPagination: tagsForPagination }) %>
<%- include('partials/footer') %>